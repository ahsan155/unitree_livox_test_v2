#FROM ubuntu:22.04
FROM dustynv/ros:humble-ros-base-l4t-r36.3.0
#FROM dustynv/ros:jazzy-ros-base-r36.4.0-cu128-24.04


# Avoid interactive prompts during package installation
ENV DEBIAN_FRONTEND=noninteractive

# Step 1: Install basic tools for managing keys
RUN apt-get update || true && \
    apt-get install -y --no-install-recommends ca-certificates curl gnupg && \
    rm -rf /var/lib/apt/lists/*

# Step 2: Overwrite *all* possible ROS keyrings with the new key
RUN set -eux; \
    curl -sSL https://raw.githubusercontent.com/ros/rosdistro/master/ros.key -o /tmp/ros.key; \
    for keyring in \
        /usr/share/keyrings/ros-archive-keyring.gpg \
        /usr/share/keyrings/ros2-archive-keyring.gpg \
        /usr/share/keyrings/ros2-latest-archive-keyring.gpg \
    ; do \
        gpg --dearmor < /tmp/ros.key > "$keyring"; \
    done; \
    rm /tmp/ros.key




# Install system dependencies, python3, pip, curl, and other tools
RUN apt-get update && apt-get install -y \
    python3-pip python3-venv python3-dev curl gnupg2 lsb-release build-essential libgl1-mesa-glx

# Setup ROS 2 repository keys and sources
#RUN curl -sSL https://raw.githubusercontent.com/ros/rosdistro/master/ros.key -o /usr/share/keyrings/ros-archive-keyring.gpg

#RUN echo "deb [arch=amd64 signed-by=/usr/share/keyrings/ros-archive-keyring.gpg] http://packages.ros.org/ros2/ubuntu jammy main" > /etc/apt/sources.list.d/ros2.list

#RUN apt-get update && apt-get install -y ros-humble-ros-base

# Source ROS and setup environment for all users
SHELL ["/bin/bash", "-c"]
RUN echo "source /opt/ros/humble/setup.bash" >> /root/.bashrc

# Add Nvidia CUDA repository key
# Install wget if not already there
RUN apt-get update && apt-get install -y wget

# Download and install the cuda-keyring
#RUN wget https://developer.download.nvidia.com/compute/cuda/repos/ubuntu2204/x86_64/cuda-keyring_1.1-1_all.deb
#RUN dpkg -i cuda-keyring_1.1-1_all.deb
#RUN rm cuda-keyring_1.1-1_all.deb

# Update apt and install the toolkit (replace with your CUDA version as needed)
#RUN apt-get update && apt-get install -y cuda-toolkit-12-4


# Upgrade pip and install Python dependencies
COPY requirements_1.txt requirements_2.txt requirements_3.txt ./

RUN pip install --upgrade pip --index-url https://pypi.org/simple
RUN pip install -r requirements_1.txt --index-url https://pypi.org/simple
RUN pip install --ignore-installed -r requirements_2.txt --index-url https://pypi.org/simple
RUN pip install -r requirements_3.txt --index-url https://pypi.org/simple


# Copy codebase
WORKDIR /usr/src/app
COPY . .

RUN ls /usr/local | grep cuda
# Environment variables for CUDA
ENV CUDA_HOME=/usr/local/cuda
ENV PATH="${CUDA_HOME}/bin:${PATH}"
ENV LD_LIBRARY_PATH="${CUDA_HOME}/lib64:${LD_LIBRARY_PATH}"
RUN echo $LD_LIBRARY_PATH

# Remove old Jetson pip configuration that points to deprecated mirrors
RUN rm -f /etc/pip.conf

#RUN pip install torch torchvision torchaudio --index-url https://pypi.jetson-ai-lab.io/sbsa/cu130
# --no-cache-dir
RUN pip install \
  https://developer.download.nvidia.com/compute/redist/jp/v60/pytorch/torch-2.4.0a0+07cecf4168.nv24.05.14710581-cp310-cp310-linux_aarch64.whl --index-url https://pypi.org/simple

RUN apt-get update && apt-get install -y libopenblas-dev


RUN python3 - <<EOF
import torch
print("Torch version:", torch.__version__)
print("CUDA available:", torch.cuda.is_available())
print("CUDA version:", torch.version.cuda)
EOF


# Build your package if needed
#RUN python3 setup.py develop
#RUN python3 -m pip install --editable .



